# ClawOS å®Œæ•´ä¹¦ç±åˆ›ä½œå·¥ä½œæµ
# åŸºäº Lobster å·¥ä½œæµå¼•æ“
# æ”¯æŒ: parallel, loop, approval, compensation

name: write-book
description: å®Œæ•´ä¹¦ç±åˆ›ä½œæµæ°´çº¿ï¼Œç¡®å®šæ€§ç¼–æ’

# è¾“å…¥å‚æ•°
input:
  title: string           # ä¹¦ç±æ ‡é¢˜
  chapters: integer       # ç« èŠ‚æ•°é‡
  wordTarget: integer     # ç›®æ ‡å­—æ•°
  taskId: string          # ä»»åŠ¡ID
  userId: string          # ç”¨æˆ·ID

# å…¨å±€å˜é‡
vars:
  blackboardBase: "~/clawos/blackboard/tasks"
  outputBase: "~/clawos/output"

# å·¥ä½œæµæ­¥éª¤
steps:
  # ============================================
  # Phase 1: è§„åˆ’é˜¶æ®µ
  # ============================================

  - name: plan
    agent: writing-pm
    prompt: |
      ä¸ºã€Š{input.title}ã€‹åˆ¶å®š {input.chapters} ç« è¯¦ç»†å¤§çº²ã€‚

      è¦æ±‚:
      1. æ¯ç« åŒ…å«ï¼šæ ‡é¢˜ã€æ ¸å¿ƒè®ºç‚¹ã€å…³é”®çŸ¥è¯†ç‚¹ï¼ˆ3-5ä¸ªï¼‰ã€å­—æ•°ç›®æ ‡
      2. ç¡®ä¿æ•´ä½“ç»“æ„è¿è´¯
      3. æ€»å­—æ•°æ§åˆ¶åœ¨ {input.wordTarget} å­—å·¦å³

      è¾“å‡ºæ ¼å¼: JSON
      è¾“å‡ºè·¯å¾„: {vars.blackboardBase}/{input.taskId}/outline.json
    output: "{vars.blackboardBase}/{input.taskId}/outline.json"
    checkpoint: true

  # éé˜»å¡é€šçŸ¥ç”¨æˆ·
  - name: notify-planning-done
    agent: "assistant-{input.userId}"
    prompt: |
      âœ… å¤§çº²å·²å®Œæˆï¼Œå³å°†å¼€å§‹å†™ä½œã€‚

      ğŸ“š ä¹¦ç±: ã€Š{input.title}ã€‹
      ğŸ“ è§„æ¨¡: {input.chapters} ç« 
      ğŸ“ é¢„è®¡: {input.wordTarget} å­—
      â± é¢„è®¡å®Œæˆ: çº¦ 90 åˆ†é’Ÿ

      æˆ‘ä¼šæ¯ 20 åˆ†é’Ÿç»™ä½ è¿›åº¦æ›´æ–°ã€‚
    async: true

  # ============================================
  # Phase 2: å¹¶è¡Œå†™ä½œé˜¶æ®µ
  # ============================================

  - name: write-chapters
    parallel:
      maxConcurrent: 2    # æœ€å¤š2ç« åŒæ—¶å†™ä½œï¼Œé¿å…èµ„æºç«äº‰
      items: "{range(1, input.chapters + 1)}"
    sub-workflow: write-single-chapter
    input:
      chapterIndex: "{item}"
      outline: "{vars.blackboardBase}/{input.taskId}/outline.json"
      taskId: "{input.taskId}"
      title: "{input.title}"

  # ============================================
  # Phase 3: ç‹¬ç«‹éªŒè¯é˜¶æ®µ
  # ============================================

  - name: validate-all
    agent: validator
    prompt: |
      éªŒè¯ ~/clawos/blackboard/tasks/{input.taskId}/chapters/ ä¸‹æ‰€æœ‰ç« èŠ‚ã€‚

      é€ç« è¯„åˆ†ï¼Œç»´åº¦:
      - å‡†ç¡®æ€§ (25%)
      - å®Œæ•´æ€§ (25%)
      - è´¨é‡ (25%)
      - è§„èŒƒ (25%)

      è¯„åˆ†æ ‡å‡†: â‰¥8.0 é€šè¿‡ï¼Œ<8.0 æ‰“å›

      è¾“å‡ºæ ¼å¼: JSON
      è¾“å‡ºè·¯å¾„: {vars.blackboardBase}/{input.taskId}/validation.md
    output: "{vars.blackboardBase}/{input.taskId}/validation.md"
    outputMapping:
      validation_score: "$.score"
      failed_chapters: "$.failedChapters"
      chapter_scores: "$.chapterScores"
    checkpoint: true

  # ============================================
  # Phase 4: æ¡ä»¶å¾ªç¯ - æ‰“å›é‡åš
  # ============================================

  - name: revision-loop
    loop:
      condition: "validation.score < 8 && iteration < 3"
      max: 3
    steps:
      - name: identify-failed-chapters
        agent: writing-pm
        prompt: |
          è¯»å–éªŒè¯ç»“æœ: {vars.blackboardBase}/{input.taskId}/validation.md
          è¯†åˆ«è¯„åˆ† < 8.0 çš„ç« èŠ‚ã€‚
          ç”Ÿæˆä¿®æ”¹è®¡åˆ’ã€‚
        output: "{vars.blackboardBase}/{input.taskId}/revision-plan.md"

      - name: revise-chapters
        parallel:
          maxConcurrent: 2
          items: "{failed_chapters}"
        agent: writer-general
        prompt: |
          æ ¹æ®éªŒè¯æ„è§ä¿®æ”¹ç¬¬ {item} ç« ã€‚

          éªŒè¯ç»“æœ: {vars.blackboardBase}/{input.taskId}/validation.md
          åŸæ–‡: {vars.blackboardBase}/{input.taskId}/chapters/ch-{item:02d}.md

          ä¿®æ”¹è¦æ±‚:
          1. é’ˆå¯¹æ€§è§£å†³éªŒè¯ä¸­æŒ‡å‡ºçš„é—®é¢˜
          2. ä¿æŒä¸å…¶ä»–ç« èŠ‚çš„ä¸€è‡´æ€§
          3. ä¸æ”¹å˜æ ¸å¿ƒå†…å®¹

      - name: revalidate
        agent: validator
        prompt: |
          é‡æ–°éªŒè¯ä¿®æ”¹åçš„ç« èŠ‚ã€‚

          æ£€æŸ¥æ˜¯å¦è§£å†³äº†ä¹‹å‰çš„é—®é¢˜ã€‚
          æ›´æ–°éªŒè¯ç»“æœã€‚

        output: "{vars.blackboardBase}/{input.taskId}/validation.md"

  # ============================================
  # Phase 5: æœ€ç»ˆæ’ç‰ˆåˆå¹¶
  # ============================================

  - name: format-and-compile
    agent: writer-general
    prompt: |
      åˆå¹¶æ‰€æœ‰ç« èŠ‚ï¼Œç»Ÿä¸€æ’ç‰ˆï¼Œç”Ÿæˆæœ€ç»ˆ Markdownã€‚

      è¦æ±‚:
      1. ç»Ÿä¸€æ ‡é¢˜æ ¼å¼
      2. ç”Ÿæˆç›®å½•
      3. æ·»åŠ å°é¢ä¿¡æ¯
      4. æ£€æŸ¥äº¤å‰å¼•ç”¨

      è¾“å‡ºè·¯å¾„: {vars.outputBase}/{input.taskId}/book.md
    output: "{vars.outputBase}/{input.taskId}/book.md"
    outputMapping:
      word_count: "$.wordCount"
      final_score: "$.finalScore"
      chapters_completed: "$.chaptersCompleted"
    checkpoint: true

  # ============================================
  # Phase 6: å®¡æ‰¹é—¨æ§ + å‘å¸ƒ
  # ============================================

  - name: publish-approval
    approval:
      required: true
      timeout: "24h"
      message: |
        ã€Š{input.title}ã€‹å·²å®Œæˆï¼Œè¯·ç¡®è®¤å‘å¸ƒã€‚

        ç»Ÿè®¡:
        - æ€»å­—æ•°: {word_count}
        - å¹³å‡è¯„åˆ†: {final_score}/10
        - ç« èŠ‚æ•°: {input.chapters}

        ç¡®è®¤åå°†æäº¤åˆ° GitHubã€‚
    onReject:
      action: "notify-user"
      message: "å‘å¸ƒå·²å–æ¶ˆï¼Œä¹¦ç±ä¿å­˜åœ¨ {vars.outputBase}/{input.taskId}/"

  - name: publish
    exec: |
      #!/bin/bash
      set -e
      cd ~/clawos/output
      git add {input.taskId}/
      git commit -m "feat: ã€Š{input.title}ã€‹ Â· taskId={input.taskId}

      - ç« èŠ‚æ•°: {input.chapters}
      - æ€»å­—æ•°: {word_count}
      - éªŒè¯è¯„åˆ†: {final_score}/10

      Generated by ClawOS Workflow Engine"
      git push origin main
    outputMapping:
      github_url: "$.githubUrl"
      commit_sha: "$.commitSha"
    checkpoint: true

  # ============================================
  # Phase 7: å®Œæˆé€šçŸ¥
  # ============================================

  - name: final-notify
    agent: "assistant-{input.userId}"
    prompt: |
      ğŸ‰ ã€Š{input.title}ã€‹å·²å®Œæˆï¼

      ğŸ“Š ç»Ÿè®¡:
      - æ€»å­—æ•°: {word_count}
      - å¹³å‡è¯„åˆ†: {final_score}/10
      - ç« èŠ‚æ•°: {input.chapters}

      ğŸ”— GitHub: {github_url}

      å¦‚éœ€ä¿®æ”¹ï¼Œå‘Šè¯‰æˆ‘å“ªé‡Œä¸æ»¡æ„ï¼Ÿ
    async: true

# ============================================
# è¡¥å¿æ“ä½œ (Saga Pattern)
# ============================================
compensations:
  write-chapters:
    action: "åˆ é™¤æœªå®Œæˆçš„ç« èŠ‚æ–‡ä»¶ï¼Œæ¸…ç©º {vars.blackboardBase}/{input.taskId}/chapters/"
    exec: "rm -rf {vars.blackboardBase}/{input.taskId}/chapters/*"

  publish:
    action: "Git revert æœ€è¿‘ä¸€æ¬¡ commit"
    exec: |
      cd ~/clawos/output
      git revert HEAD --no-edit
      git push origin main

# ============================================
# é”™è¯¯å¤„ç†
# ============================================
onError:
  escalate:
    agent: gm
    message: "ä»»åŠ¡ {input.taskId} åœ¨æ­¥éª¤ {failed_step} å¤±è´¥ï¼Œéœ€è¦ä»‹å…¥"
    writeToBlackboard: "{vars.blackboardBase}/{input.taskId}/escalation.md"

  retry:
    maxAttempts: 2
    backoff: "exponential"
    initialDelay: "30s"

# ============================================
# å­å·¥ä½œæµå®šä¹‰
# ============================================
subWorkflows:
  write-single-chapter:
    name: write-single-chapter
    input:
      chapterIndex: integer
      outline: string
      taskId: string
      title: string

    steps:
      - name: write
        agent: writer-general
        prompt: |
          æ’°å†™ã€Š{input.title}ã€‹ç¬¬ {input.chapterIndex} ç« ã€‚

          å¤§çº²å‚è€ƒ: {input.outline}

          è¦æ±‚:
          1. ä¸¥æ ¼éµå¾ªå¤§çº²
          2. å­—æ•°ç¬¦åˆç›®æ ‡
          3. é£æ ¼ç»Ÿä¸€

          è¾“å‡ºè·¯å¾„: ~/clawos/blackboard/tasks/{input.taskId}/chapters/ch-{input.chapterIndex:02d}.md
        output: "~/clawos/blackboard/tasks/{input.taskId}/chapters/ch-{input.chapterIndex:02d}.md"
        checkpoint: true

      - name: notify-chapter-done
        agent: "assistant-{input.userId}"
        prompt: |
          âœ… ç¬¬ {input.chapterIndex} ç« å·²å®Œæˆ
        async: true
