# ClawOS éƒ¨ç½²å·¥ä½œæµ
# åŸºäº Lobster å·¥ä½œæµå¼•æ“
# éƒ¨ç½²æµæ°´çº¿ï¼šæ„å»º â†’ æµ‹è¯• â†’ éƒ¨ç½² â†’ éªŒè¯

name: deploy-task
description: éƒ¨ç½²æµæ°´çº¿ï¼Œæ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²

# è¾“å…¥å‚æ•°
input:
  taskId: string          # ä»»åŠ¡ID
  projectId: string       # é¡¹ç›®ID
  environment: string     # éƒ¨ç½²ç¯å¢ƒ: staging|production
  version: string         # éƒ¨ç½²ç‰ˆæœ¬
  userId: string          # ç”¨æˆ·ID

# å…¨å±€å˜é‡
vars:
  blackboardBase: "~/clawos/blackboard/tasks"
  deployBase: "~/clawos/deployments"

# å·¥ä½œæµæ­¥éª¤
steps:
  # ============================================
  # Phase 1: é¢„æ£€æŸ¥
  # ============================================
  - name: precheck
    agent: sreagent
    prompt: |
      æ‰§è¡Œéƒ¨ç½²å‰æ£€æŸ¥ã€‚

      ä»»åŠ¡ID: {input.taskId}
      é¡¹ç›®ID: {input.projectId}
      ç›®æ ‡ç¯å¢ƒ: {input.environment}

      æ£€æŸ¥é¡¹:
      1. ä»£ç æ˜¯å¦å·²æäº¤ï¼Ÿ
      2. æµ‹è¯•æ˜¯å¦å…¨éƒ¨é€šè¿‡ï¼Ÿ
      3. ä¾èµ–æ˜¯å¦å°±ç»ªï¼Ÿ
      4. é…ç½®æ˜¯å¦æ­£ç¡®ï¼Ÿ

      è¾“å‡ºè·¯å¾„: {vars.blackboardBase}/{input.taskId}/precheck.md
    output: "{vars.blackboardBase}/{input.taskId}/precheck.md"
    outputMapping:
      previous_version: "$.currentVersion"
      checks_passed: "$.checksPassed"
      warnings: "$.warnings"
    checkpoint: true

  # ============================================
  # Phase 2: æ„å»º
  # ============================================
  - name: build
    agent: sreagent
    prompt: |
      æ„å»ºé¡¹ç›®ã€‚

      ä»»åŠ¡ID: {input.taskId}
      é¡¹ç›®ID: {input.projectId}
      ç‰ˆæœ¬: {input.version}

      æ„å»ºæ­¥éª¤:
      1. å®‰è£…ä¾èµ–
      2. ç¼–è¯‘ä»£ç 
      3. æ‰“åŒ…äº§ç‰©
      4. ç”Ÿæˆé•œåƒï¼ˆå¦‚é€‚ç”¨ï¼‰

      è¾“å‡ºè·¯å¾„: {vars.blackboardBase}/{input.taskId}/build.log
    output: "{vars.blackboardBase}/{input.taskId}/build.log"
    outputMapping:
      build_artifact: "$.artifact"
      build_time: "$.buildTime"
      image_tag: "$.imageTag"
    checkpoint: true

  # ============================================
  # Phase 3: éƒ¨ç½²å‰æµ‹è¯•
  # ============================================
  - name: test
    agent: tester-auto
    prompt: |
      æ‰§è¡Œéƒ¨ç½²å‰æµ‹è¯•ã€‚

      ä»»åŠ¡ID: {input.taskId}
      æ„å»ºäº§ç‰©: {vars.deployBase}/{input.projectId}/{input.version}

      æµ‹è¯•ç±»å‹:
      1. é›†æˆæµ‹è¯•
      2. E2E æµ‹è¯•
      3. æ€§èƒ½åŸºå‡†æµ‹è¯•

      è¾“å‡ºè·¯å¾„: {vars.blackboardBase}/{input.taskId}/test-report.md
    output: "{vars.blackboardBase}/{input.taskId}/test-report.md"
    outputMapping:
      test_result: "$.result"
      test_passed: "$.passed"
      test_failed: "$.failed"
      performance_baseline: "$.performanceBaseline"
    checkpoint: true

  # ============================================
  # Phase 4: å®¡æ‰¹é—¨æ§
  # ============================================
  - name: deploy-approval
    approval:
      required: true
      timeout: "2h"
      message: |
        ğŸš€ å‡†å¤‡éƒ¨ç½²åˆ° {input.environment}

        é¡¹ç›®: {input.projectId}
        ç‰ˆæœ¬: {input.version}

        æµ‹è¯•ç»“æœ: {test_result}
        æ„å»ºäº§ç‰©: {build_artifact}

        ç¡®è®¤éƒ¨ç½²ï¼Ÿ
    onReject:
      action: "notify-user"
      message: "éƒ¨ç½²å·²å–æ¶ˆ"

  # ============================================
  # Phase 5: éƒ¨ç½²
  # ============================================
  - name: deploy
    agent: sreagent
    prompt: |
      æ‰§è¡Œéƒ¨ç½²ã€‚

      ä»»åŠ¡ID: {input.taskId}
      é¡¹ç›®ID: {input.projectId}
      ç¯å¢ƒ: {input.environment}
      ç‰ˆæœ¬: {input.version}

      éƒ¨ç½²æ­¥éª¤:
      1. å¤‡ä»½å½“å‰ç‰ˆæœ¬
      2. éƒ¨ç½²æ–°ç‰ˆæœ¬
      3. å¥åº·æ£€æŸ¥
      4. æµé‡åˆ‡æ¢

      è¾“å‡ºè·¯å¾„: {vars.blackboardBase}/{input.taskId}/deploy.log
    output: "{vars.blackboardBase}/{input.taskId}/deploy.log"
    outputMapping:
      deploy_time: "$.deployTime"
      deployed_version: "$.version"
      rollback_version: "$.previousVersion"
    checkpoint: true

  # ============================================
  # Phase 6: éƒ¨ç½²åéªŒè¯
  # ============================================
  - name: verify
    agent: validator
    prompt: |
      éªŒè¯éƒ¨ç½²ç»“æœã€‚

      ä»»åŠ¡ID: {input.taskId}
      ç¯å¢ƒ: {input.environment}
      éƒ¨ç½²ç‰ˆæœ¬: {input.version}

      éªŒè¯é¡¹:
      1. æœåŠ¡å¥åº·æ£€æŸ¥
      2. å…³é”®åŠŸèƒ½å†’çƒŸæµ‹è¯•
      3. æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”
      4. é”™è¯¯ç‡ç›‘æ§

      è¯„åˆ†æ ‡å‡†: æ‰€æœ‰å…³é”®æŒ‡æ ‡æ­£å¸¸

      è¾“å‡ºè·¯å¾„: {vars.blackboardBase}/{input.taskId}/verification.md
    output: "{vars.blackboardBase}/{input.taskId}/verification.md"
    outputMapping:
      monitor_url: "$.monitorUrl"
      health_status: "$.healthStatus"
      failure_reason: "$.failureReason"
    checkpoint: true

  # ============================================
  # Phase 7: æ¡ä»¶å›æ»š
  # ============================================
  - name: rollback-check
    loop:
      condition: "verification.status == 'failed' && iteration < 1"
      max: 1
    steps:
      - name: rollback
        agent: sreagent
        prompt: |
          éƒ¨ç½²éªŒè¯å¤±è´¥ï¼Œæ‰§è¡Œå›æ»šã€‚

          ä»»åŠ¡ID: {input.taskId}
          ç¯å¢ƒ: {input.environment}
          å›æ»šåˆ°: {previous_version}

          å›æ»šæ­¥éª¤:
          1. åˆ‡æ¢æµé‡åˆ°æ—§ç‰ˆæœ¬
          2. æ¢å¤é…ç½®
          3. å¥åº·æ£€æŸ¥

        output: "{vars.blackboardBase}/{input.taskId}/rollback.log"

      - name: notify-rollback
        agent: assistant
        prompt: |
          âš ï¸ éƒ¨ç½²å¤±è´¥ï¼Œå·²è‡ªåŠ¨å›æ»š

          ä»»åŠ¡ID: {input.taskId}
          ç¯å¢ƒ: {input.environment}
          å¤±è´¥åŸå› : {failure_reason}
          å½“å‰ç‰ˆæœ¬: {previous_version}

          è¯·æ£€æŸ¥é—®é¢˜åé‡æ–°éƒ¨ç½²ã€‚
        async: true

  # ============================================
  # Phase 8: å®Œæˆé€šçŸ¥
  # ============================================
  - name: notify-success
    agent: assistant
    prompt: |
      âœ… éƒ¨ç½²æˆåŠŸ

      ä»»åŠ¡ID: {input.taskId}
      é¡¹ç›®: {input.projectId}
      ç¯å¢ƒ: {input.environment}
      ç‰ˆæœ¬: {input.version}

      éƒ¨ç½²æ—¶é—´: {deploy_time}
      éªŒè¯ç»“æœ: é€šè¿‡

      ç›‘æ§é¢æ¿: {monitor_url}
    async: true

# ============================================
# è¡¥å¿æ“ä½œ
# ============================================
compensations:
  deploy:
    action: "è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬"
    exec: |
      # å›æ»šè„šæœ¬
      kubectl rollout undo deployment/{input.projectId} -n {input.environment}

# ============================================
# é”™è¯¯å¤„ç†
# ============================================
onError:
  escalate:
    agent: gm
    message: "éƒ¨ç½²ä»»åŠ¡ {input.taskId} åœ¨æ­¥éª¤ {failed_step} å¤±è´¥"
    writeToBlackboard: "{vars.blackboardBase}/{input.taskId}/escalation.md"

  retry:
    maxAttempts: 1
    backoff: "fixed"
    initialDelay: "60s"
