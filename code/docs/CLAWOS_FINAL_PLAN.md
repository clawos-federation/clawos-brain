# ClawOS 最终规划文档 (Final Plan)

> **文档版本**: v2.0
> **创建日期**: 2026-02-24
> **最后更新**: 2026-02-24
> **状态**: Active

---

## 📋 目录

1. [愿景与使命](#愿景与使命)
2. [系统架构](#系统架构)
3. [15 Agents 三层架构](#15-agents-三层架构)
4. [五大铁律](#五大铁律)
5. [并发约束与 Session 管理](#并发约束与-session-管理)
6. [两阶段响应模型](#两阶段响应模型)
7. [核心功能模块](#核心功能模块)
8. [代理体系](#代理体系)
9. [数据架构](#数据架构)
10. [部署策略](#部署策略)
11. [监控与运维](#监控与运维)
12. [安全策略](#安全策略)
13. [优化路线图](#优化路线图)
14. [成本控制](#成本控制)

---

## 🎯 愿景与使命

### 愿景
构建一个**完全自主、高度智能、成本优化**的 AI 操作系统，实现：
- 🤖 多代理协同工作
- 💰 87% 免费 API 调用（使用国产模型）
- 🔄 双环境冗余（本地 + Codespace）
- 📊 实时数据驱动决策

### 使命
1. **自动化** - 减少人工干预，提升效率
2. **智能化** - 数据驱动的决策支持
3. **成本优化** - 最大化免费资源利用
4. **可靠性** - 多环境备份，确保稳定性

---

## 🏗️ 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                    OpenClaw Gateway                      │
│                  (统一入口 + 认证)                        │
└─────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
┌───────▼────────┐  ┌───────▼────────┐  ┌──────▼────────┐
│  本地环境      │  │  Codespace     │  │  其他节点     │
│  ~/clawos      │  │  Remote        │  │  (Future)     │
├────────────────┤  ├────────────────┤  ├───────────────┤
│ - 快速响应     │  │ - 24/7 运行    │  │ - 扩展计算    │
│ - 低延迟       │  │ - 自动化任务   │  │ - 离线处理    │
│ - 数据缓存     │  │ - 数据分析     │  │               │
└────────────────┘  └────────────────┘  └───────────────┘
```

### 环境分工

| 环境 | 角色 | 主要任务 | 成本 |
|------|------|----------|------|
| **本地** | 主控制台 | 交互、监控、轻量计算 | 免费 |
| **Codespace** | 工作节点 | 定时任务、数据分析、长期运行 | $0.36/天 |
| **未来节点** | 扩展计算 | 离线批处理、重计算任务 | 按需 |

---

## 🤖 15 Agents 三层架构

### 架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                 L1: Command Layer (指挥层)                   │
│      assistant (入口) │ gm (决策) │ validator (验证)         │
│                           3 Agents                           │
└─────────────────────────────────────────────────────────────┘
                              ↓ 仅调用 PM 层
┌─────────────────────────────────────────────────────────────┐
│                   L2: PM Layer (项目管理层)                  │
│    platform-pm │ coding-pm │ writing-pm                     │
│                           3 Agents                           │
└─────────────────────────────────────────────────────────────┘
                              ↓ 仅调用 Worker 层
┌─────────────────────────────────────────────────────────────┐
│                 L3: Workers Layer (执行层)                   │
│  coder-* │ writer-* │ tester-* │ researcher-* │ sre-* │ sec-*│
│                           9 Agents                           │
└─────────────────────────────────────────────────────────────┘
```

### Agent 完整列表

| 层级 | Agent ID | 名称 | 职责 | 模型 |
|------|----------|------|------|------|
| **L1** | `assistant` | ClawOS Assistant | 唯一人机入口，接收意图，主动汇报 | glm-5 |
| **L1** | `gm` | ClawOS GM | 总经理，任务评估，PM任命，最终验收 | glm-5 |
| **L1** | `validator` | ClawOS Validator | 独立质量验证，Blueprint审核 | glm-5 |
| **L2** | `platform-pm` | Platform PM | 造Agent、建Skill、维护生态 | glm-5 |
| **L2** | `coding-pm` | Coding PM | 开发任务、组建开发团队 | glm-5 |
| **L2** | `writing-pm` | Writing PM | 写作任务、组建写作团队 | glm-5 |
| **L3** | `coder-frontend` | Coder Frontend | 前端开发 | glm-5 |
| **L3** | `coder-backend` | Coder Backend | 后端开发 | glm-5 |
| **L3** | `tester-auto` | Tester Auto | 测试编写、执行 | glm-5 |
| **L3** | `github-ops` | GitHub Ops | Git操作、PR管理 | glm-5 |
| **L3** | `writer-general` | Writer General | 通用写作 | glm-5 |
| **L3** | `researcher-web` | Researcher Web | 调研分析 | glm-5 |
| **L3** | `reviewer-content` | Reviewer Content | 内容审核 | glm-5 |
| **L3** | `sreagent` | SREAgent | 运维专家，系统健康监控 | glm-5 |
| **L3** | `securityagent` | SecurityAgent | 安全专家，安全审计 | glm-5 |

### 调度链规则

```
用户 (L0)
    ↓ 调度
L1: Assistant (唯一人机入口)
    ↓ 调度
L2: GM → PM层 (coding-pm / writing-pm / platform-pm)
    ↓ 调度
L3: Worker层 (coder-* / writer-* / tester-* / ...)
```

**关键规则**:
- ✅ GM 只能调用 PM 层 + validator
- ✅ PM 只能调用指定的 Worker 层 Agent
- ❌ 禁止跨层调度（L1 直接调用 L3）

---

## ⚖️ 五大铁律

### 铁律 1: 用户体验 Lane 永不被长任务污染
- 长任务必须下沉到 Sub-agent
- 主 Session 保持响应性
- 用户体验优先级最高

### 铁律 2: 每个用户独立 Session
- 用户隔离，互不干扰
- Session 上下文独立
- 防止交叉污染

### 铁律 3: 长任务下沉到 Sub-agent
- 超过 30s 的任务自动下沉
- Sub-agent 异步执行
- 主线程不被阻塞

### 铁律 4: Sub-agent 按优先级分层
```
P0 (Critical): 安全漏洞、系统崩溃
P1 (High):     功能阻塞、数据丢失风险
P2 (Medium):   正常功能请求
P3 (Low):      优化、文档改进
```

### 铁律 5: Heartbeat 是最高优先级
- Heartbeat 任务不可被抢占
- 定期汇报系统状态
- 检测异常并主动通知

---

## 🔒 并发约束与 Session 管理

### 并发约束配置

| 参数 | 值 | 说明 |
|------|-----|------|
| `maxConcurrent` | 8 | 最大并发任务数 |
| `subagents.maxConcurrent` | 6 | Sub-agent 最大并发数 |
| `subagents.maxChildrenPerAgent` | 4 | 每个 Agent 最大子节点数 |
| `subagents.maxSpawnDepth` | 2 | 最大 Spawn 深度 |

### Session 管理配置

| 参数 | 值 | 说明 |
|------|-----|------|
| `idleTimeout` | 1800s (30min) | 空闲超时 |
| `maxTasksBeforeReset` | 50 | 重置前最大任务数 |
| `maxContextPercent` | 80% | 最大上下文使用率 |

### 文件锁策略

- 使用 `.lock` 文件防止并发写入冲突
- Session 文件: `sessions/*.jsonl.lock`
- 写入前获取锁，完成后释放

---

## 📡 两阶段响应模型

### T+0s: 立即确认 (3秒内)

```
用户请求 → Assistant 立即响应
         → "已收到任务，正在调度 coding-pm 执行..."
         → 返回任务 ID
```

**要求**:
- 必须在 3 秒内响应
- 明确告知用户任务状态
- 提供任务追踪 ID

### T+N: 异步执行 + 主动推送

```
任务完成 → Heartbeat 主动汇报
        → "任务 #xxx 已完成，结果位于 /path/to/file"
        → 可选: 通过 iMessage 推送通知
```

**推送渠道**:
- ClawOS 控制台
- iMessage (紧急任务)
- Blackboard 状态更新

---

## 🧩 核心功能模块

### 1. Alpha Commander (量化交易)

**功能**: 自动化股票信号生成与交易决策

```
数据源 → 策略引擎 → 信号生成 → 风险评估 → 执行建议
  ↓         ↓           ↓          ↓          ↓
市场数据   Alpha-v1    买卖信号   置信度     用户确认
```

**当前状态**:
- ✅ 信号生成正常 (每6小时)
- ✅ 运行稳定 (24/7)
- ⚠️ 市场数据源有错误 (需修复)

**优化方向**:
- [ ] 修复市场数据源
- [ ] 增加多策略支持
- [ ] 添加回测功能
- [ ] 接入实盘交易

---

### 2. Blackboard (数据面板)

**功能**: 跨环境数据同步与状态管理

```
blackboard/
├── alpha/
│   └── signals/         # 交易信号
├── platform-pm/
│   ├── health-reports/  # 健康报告
│   └── latest-status.json
├── tasks/
│   ├── pending.md       # 待办任务
│   └── escalation.md    # 紧急升级
└── heartbeat-state.json # 心跳状态
```

**当前问题**:
- ❌ 本地 blackboard 几乎为空 (140KB)
- ❌ 数据未同步
- ❌ 无任务追踪机制

**解决方案**:
1. 建立 Git 同步机制
2. 定时同步关键数据
3. 增加变更通知

---

### 3. Memory System (记忆系统)

**功能**: 长期记忆与上下文管理

**配置**:
```json
{
  "provider": "local",
  "model": "embeddinggemma-300m-qat-q8_0.gguf",
  "cost": "免费"
}
```

**优势**:
- ✅ 完全本地运行
- ✅ 隐私保护
- ✅ 无 API 费用

**改进计划**:
- [ ] 增加记忆索引优化
- [ ] 实现跨环境记忆同步
- [ ] 添加记忆检索性能监控

---

## 🤖 代理体系 (补充)

> **详细架构请参考**: [15 Agents 三层架构](#15-agents-三层架构)

### 模型成本策略

| 模型 | 提供商 | 成本 | 用途 |
|------|--------|------|------|
| glm-5 | zai (智谱) | 免费 | 所有 Agent 默认模型 |
| claude-opus-4-6-thinking | vectorengine | 付费 | 复杂推理任务 (备用) |
| gpt-5.3-codex | openai | 付费 | 代码生成 (备用) |

### 成本优化原则

1. **默认使用免费模型** - 87% 调用使用 glm-5
2. **按需升级** - 仅在免费模型无法满足时使用付费模型
3. **本地 Embedding** - 使用本地模型，无 API 费用

---

## 📊 数据架构

### 数据流向

```
外部数据源
    ↓
[数据采集] (Codespace)
    ↓
[数据处理] (策略引擎)
    ↓
[信号生成] (Alpha Commander)
    ↓
[数据存储] (Blackboard)
    ↓
[数据同步] (Git/S3)
    ↓
[本地访问] (Dashboard)
```

### 数据存储策略

| 数据类型 | 存储位置 | 同步频率 | 保留时长 |
|---------|---------|---------|---------|
| 交易信号 | blackboard/alpha | 实时 | 30 天 |
| 健康报告 | blackboard/platform-pm | 每小时 | 7 天 |
| 记忆数据 | memory/ | 实时 | 永久 |
| 日志文件 | logs/ | 实时 | 7 天 |

---

## 🚀 部署策略

### 双环境部署

#### 本地环境 (Primary)

**用途**: 交互式操作、实时监控

**配置**:
```bash
工作空间: ~/clawos
Gateway: 本地运行 (127.0.0.1:18789)
Embedding: 本地 (免费)
Cost: $0
```

**启动命令**:
```bash
openclaw gateway
```

#### Codespace 环境 (Secondary)

**用途**: 后台任务、长期运行

**配置**:
```bash
工作空间: ~/clawos (remote)
运行模式: 24/7
Cost: $0.36/天
Auto-run: ./auto-run.sh
```

**启动命令**:
```bash
gh codespace ssh -c verbose-spork-pj7wqgxpw479cq7x \
  -- "cd ~/clawos && ./auto-run.sh"
```

---

## 🔍 监控与运维

### 健康检查机制

#### 自动心跳 (Heartbeat)

**频率**: 每 30 分钟
**检查项**:
- [ ] Blackboard 任务状态
- [ ] Codespace 连接状态
- [ ] 信号更新时间
- [ ] 系统资源使用

**告警规则**:
- 🔴 信号 > 12 小时未更新 → 立即通知
- 🟡 Codespace 断开 > 1 小时 → 警告
- 🟢 所有正常 → HEARTBEAT_OK

#### 性能监控

| 指标 | 阈值 | 告警级别 |
|------|------|---------|
| CPU 使用率 | > 80% | 🟡 警告 |
| 内存使用 | > 90% | 🔴 严重 |
| 磁盘空间 | < 10% | 🔴 严重 |
| 响应时间 | > 5s | 🟡 警告 |

---

## 🔒 安全策略

### 认证与授权

#### Gateway Token

```
当前: 64 字符 (已优化)
轮换: 每 90 天
存储: ~/.openclaw/openclaw.json (权限 600)
```

#### SSH 连接安全

**当前状态**:
```
✅ 使用 SSH key 认证
✅ 禁用密码登录
⚠️ 5 个活跃连接 (建议精简)
```

**改进措施**:
- [ ] 定期清理僵尸连接
- [ ] 增加连接超时设置
- [ ] 记录连接日志

### API Keys 管理

**配置方式**:
```json
{
  "auth": {
    "profiles": {
      "zai:default": {
        "provider": "zai",
        "mode": "api_key"
      }
    }
  }
}
```

**安全建议**:
- ✅ 使用环境变量 (推荐)
- ✅ 定期轮换 keys
- ✅ 限制权限范围

---

## 🛣️ 优化路线图

### Phase 1: 稳定性 (Q1 2026) ✅

- [x] 修复 openai-codex provider
- [x] 配置本地 embedding (免费)
- [x] 升级 Gateway token
- [x] 创建 memory 目录
- [ ] 修复市场数据源错误
- [ ] 建立 blackboard 同步机制

### Phase 2: 性能优化 (Q2 2026)

- [ ] 精简未使用的代理
- [ ] 优化信号生成频率
- [ ] 实现数据压缩
- [ ] 增加缓存层

### Phase 3: 功能扩展 (Q3 2026)

- [ ] 多策略支持 (Alpha-v2, v3)
- [ ] 回测系统
- [ ] 实盘交易接入
- [ ] 移动端监控

### Phase 4: 自动化 (Q4 2026)

- [ ] 自动故障恢复
- [ ] 智能资源调度
- [ ] 预测性维护
- [ ] 成本自动优化

---

## 💰 成本控制

### 当前成本结构

| 项目 | 成本 | 占比 |
|------|------|------|
| **模型调用** | | |
| - glm-5 (免费) | $0 | 0% |
| - Claude/GPT (付费) | $0 (未使用) | 0% |
| **基础设施** | | |
| - Codespace | $0.36/天 | 100% |
| - 本地环境 | $0 | 0% |
| **总计** | **$10.8/月** | 100% |

### 成本优化目标

**当前**: $10.8/月
**目标**: <$5/月 (54% 降低)

**优化措施**:
1. **代理精简** - 停用未使用的代理 (节省潜在成本)
2. **智能调度** - 按需启动 Codespace (节省 50%)
3. **本地优先** - 尽量使用本地计算 (节省 100%)
4. **批量处理** - 合并小任务 (减少调用次数)

### ROI 分析

**投入**:
- 开发时间: ~40 小时
- 运行成本: $10.8/月

**产出**:
- 自动化节省: ~10 小时/月
- 决策支持: 价值难以量化
- 学习成长: 无价

**回本周期**: 约 4 个月

---

## 📝 待办事项

### 高优先级 (本周)

- [ ] 修复市场数据源错误
- [ ] 建立 blackboard 同步机制
- [ ] 精简未使用的代理
- [ ] 编写运维手册

### 中优先级 (本月)

- [ ] 增加监控告警
- [ ] 优化信号生成策略
- [ ] 完善文档系统
- [ ] 实现自动备份

### 低优先级 (本季度)

- [ ] 开发移动端界面
- [ ] 增加多策略支持
- [ ] 接入实盘交易
- [ ] 性能基准测试

---

## 📚 参考资料

### 内部文档

- [AGENTS.md](../AGENTS.md) - 代理配置
- [HEARTBEAT.md](../HEARTBEAT.md) - 心跳机制
- [MEMORY.md](../MEMORY.md) - 记忆系统

### 外部资源

- [OpenClaw 官方文档](https://docs.openclaw.ai)
- [GitHub 仓库](https://github.com/openclaw/openclaw)
- [社区支持](https://discord.com/invite/clawd)

---

## 📞 联系与支持

**主要维护者**: Henry (assistant agent)
**技术支持**: GM Agent
**紧急联系**: 通过 OpenClaw Control UI

---

## 📅 更新日志

### v2.0 (2026-02-24)
- ✅ 更新为 15 Agents 三层架构
- ✅ 添加五大铁律
- ✅ 添加并发约束与 Session 管理
- ✅ 添加两阶段响应模型
- ✅ 优化代理体系章节
- ✅ 配置已同步到运行时

### v1.0 (2026-02-24)
- ✅ 初始版本创建
- ✅ 完成系统架构设计
- ✅ 制定优化路线图
- ✅ 成本控制分析

---

**文档状态**: ✅ Active - 已生效
**配置同步**: clawos/openclaw.json → ~/.openclaw/openclaw.json

---

*此文档是 ClawOS 的总体规划，将根据实际运行情况持续更新。*
